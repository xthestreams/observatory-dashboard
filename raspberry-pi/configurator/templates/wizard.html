{% extends "base.html" %}

{% block title %}Setup Wizard - Observatory Configurator{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Setup Wizard</h1>
    <p class="subtitle">Configure your observatory data collector step by step</p>
</div>

<!-- Progress Bar -->
<div class="wizard-progress">
    <div class="progress-steps">
        <div class="step active" data-step="1">
            <span class="step-number">1</span>
            <span class="step-label">API</span>
        </div>
        <div class="step" data-step="2">
            <span class="step-number">2</span>
            <span class="step-label">Weather</span>
        </div>
        <div class="step" data-step="3">
            <span class="step-number">3</span>
            <span class="step-label">SQM</span>
        </div>
        <div class="step" data-step="4">
            <span class="step-number">4</span>
            <span class="step-label">Cloud</span>
        </div>
        <div class="step" data-step="5">
            <span class="step-number">5</span>
            <span class="step-label">AllSky</span>
        </div>
        <div class="step" data-step="6">
            <span class="step-number">6</span>
            <span class="step-label">BOM</span>
        </div>
        <div class="step" data-step="7">
            <span class="step-number">7</span>
            <span class="step-label">Review</span>
        </div>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
    </div>
</div>

<!-- Wizard Steps -->
<form id="wizard-form">

    <!-- Step 1: API Connection -->
    <div class="wizard-step active" data-step="1">
        <div class="card">
            <div class="card-header">
                <h2>API Connection</h2>
            </div>
            <div class="card-body">
                <p class="step-description">
                    Connect to your Vercel-hosted dashboard. You'll need the deployment URL and the API key
                    from your Vercel environment variables.
                </p>

                <div class="form-group">
                    <label for="api_url">Dashboard URL</label>
                    <input type="url" id="api_url" name="REMOTE_API_URL"
                           value="{{ config.REMOTE_API_URL }}"
                           placeholder="https://your-site.vercel.app/api/ingest"
                           required>
                    <span class="help-text">The full URL to your Vercel deployment's ingest endpoint</span>
                </div>

                <div class="form-group">
                    <label for="api_key">API Key</label>
                    <input type="password" id="api_key" name="API_KEY"
                           value="{{ config.API_KEY }}"
                           placeholder="Enter your INGEST_API_KEY"
                           required>
                    <span class="help-text">The INGEST_API_KEY from your Vercel environment variables</span>
                </div>

                <button type="button" class="btn btn-primary" onclick="testStep1()">
                    Test Connection
                </button>
                <div id="step1-result" class="test-result"></div>
            </div>
        </div>
    </div>

    <!-- Step 2: Weather Stations (Davis) - Up to 3 -->
    <div class="wizard-step" data-step="2">
        <div class="card">
            <div class="card-header">
                <h2>Davis WeatherLink Live</h2>
                <span class="badge">Up to 3 devices</span>
            </div>
            <div class="card-body">
                <p class="step-description">
                    Configure your Davis WeatherLink Live device(s) for temperature, humidity, wind, and pressure data.
                    Serial numbers (lsid) are automatically detected.
                </p>

                {% for i in range(1, 4) %}
                <div class="device-slot">
                    <div class="device-slot-header">
                        <h4>Weather Station {{ i }}</h4>
                        <label class="toggle-switch">
                            <input type="checkbox" id="davis_{{ i }}_enabled"
                                   {% if config['DAVIS_' ~ i ~ '_HOST'] %}checked{% endif %}
                                   onchange="toggleDeviceSlot('davis', {{ i }})">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="device-slot-fields" id="davis-{{ i }}-fields" style="display: {% if config['DAVIS_' ~ i ~ '_HOST'] %}block{% else %}none{% endif %}">
                        <div class="form-row">
                            <div class="form-group">
                                <label>IP Address</label>
                                <input type="text" id="davis_{{ i }}_host" name="DAVIS_{{ i }}_HOST"
                                       value="{{ config['DAVIS_' ~ i ~ '_HOST'] }}"
                                       placeholder="192.168.1.x">
                            </div>
                            <div class="form-group">
                                <label>Interval (s)</label>
                                <input type="number" id="davis_{{ i }}_interval" name="DAVIS_{{ i }}_INTERVAL"
                                       value="{{ config['DAVIS_' ~ i ~ '_INTERVAL'] or '30' }}"
                                       min="10" max="120">
                            </div>
                            <div class="form-group form-group-btn">
                                <button type="button" class="btn btn-sm" onclick="testDavis({{ i }})">Test</button>
                            </div>
                        </div>
                        <div id="davis-{{ i }}-result" class="test-result"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Step 3: SQM Devices - Up to 3 -->
    <div class="wizard-step" data-step="3">
        <div class="card">
            <div class="card-header">
                <h2>Sky Quality Meters (SQM-LE)</h2>
                <span class="badge">Up to 3 devices</span>
            </div>
            <div class="card-body">
                <p class="step-description">
                    Configure your Unihedron SQM-LE sky quality meter(s) for darkness measurements.
                    Serial numbers are automatically detected from each device.
                </p>

                {% for i in range(1, 4) %}
                <div class="device-slot">
                    <div class="device-slot-header">
                        <h4>SQM {{ i }}</h4>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sqm_{{ i }}_enabled"
                                   {% if config['SQM_' ~ i ~ '_HOST'] %}checked{% endif %}
                                   onchange="toggleDeviceSlot('sqm', {{ i }})">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="device-slot-fields" id="sqm-{{ i }}-fields" style="display: {% if config['SQM_' ~ i ~ '_HOST'] %}block{% else %}none{% endif %}">
                        <div class="form-row">
                            <div class="form-group">
                                <label>IP Address</label>
                                <input type="text" id="sqm_{{ i }}_host" name="SQM_{{ i }}_HOST"
                                       value="{{ config['SQM_' ~ i ~ '_HOST'] }}"
                                       placeholder="192.168.1.x">
                            </div>
                            <div class="form-group">
                                <label>Port</label>
                                <input type="number" id="sqm_{{ i }}_port" name="SQM_{{ i }}_PORT"
                                       value="{{ config['SQM_' ~ i ~ '_PORT'] or '10001' }}"
                                       placeholder="10001">
                            </div>
                            <div class="form-group form-group-btn">
                                <button type="button" class="btn btn-sm" onclick="testSqm({{ i }})">Test</button>
                            </div>
                        </div>
                        <div id="sqm-{{ i }}-result" class="test-result"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Step 4: Cloudwatcher Devices - Up to 3 -->
    <div class="wizard-step" data-step="4">
        <div class="card">
            <div class="card-header">
                <h2>AAG Cloudwatcher</h2>
                <span class="badge">Up to 3 devices</span>
            </div>
            <div class="card-body">
                <p class="step-description">
                    Configure your AAG Cloudwatcher device(s) for cloud, rain, and sky condition monitoring.
                    Serial numbers are automatically detected from each device.
                </p>

                {% for i in range(1, 4) %}
                <div class="device-slot">
                    <div class="device-slot-header">
                        <h4>Cloudwatcher {{ i }}</h4>
                        <label class="toggle-switch">
                            <input type="checkbox" id="cloudwatcher_{{ i }}_enabled"
                                   {% if config['CLOUDWATCHER_' ~ i ~ '_HOST'] %}checked{% endif %}
                                   onchange="toggleDeviceSlot('cloudwatcher', {{ i }})">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="device-slot-fields" id="cloudwatcher-{{ i }}-fields" style="display: {% if config['CLOUDWATCHER_' ~ i ~ '_HOST'] %}block{% else %}none{% endif %}">
                        <div class="form-row">
                            <div class="form-group">
                                <label>IP Address</label>
                                <input type="text" id="cloudwatcher_{{ i }}_host" name="CLOUDWATCHER_{{ i }}_HOST"
                                       value="{{ config['CLOUDWATCHER_' ~ i ~ '_HOST'] }}"
                                       placeholder="192.168.1.x">
                            </div>
                            <div class="form-group">
                                <label>Interval (s)</label>
                                <input type="number" id="cloudwatcher_{{ i }}_interval" name="CLOUDWATCHER_{{ i }}_INTERVAL"
                                       value="{{ config['CLOUDWATCHER_' ~ i ~ '_INTERVAL'] or '30' }}"
                                       min="10" max="120">
                            </div>
                            <div class="form-group form-group-btn">
                                <button type="button" class="btn btn-sm" onclick="testCloudwatcher({{ i }})">Test</button>
                            </div>
                        </div>
                        <div id="cloudwatcher-{{ i }}-result" class="test-result"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Step 5: AllSky -->
    <div class="wizard-step" data-step="5">
        <div class="card">
            <div class="card-header">
                <h2>AllSky Camera</h2>
                <label class="toggle-switch">
                    <input type="checkbox" id="allsky_enabled"
                           {% if config.ALLSKY_IMAGE_PATH or config.ALLSKY_IMAGE_URL %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="card-body">
                <p class="step-description">
                    Configure your AllSky camera image source. You can use a local file path or a URL.
                </p>

                <div class="conditional-fields" id="allsky-fields">
                    <div class="form-group">
                        <label for="allsky_path">Local File Path</label>
                        <input type="text" id="allsky_path" name="ALLSKY_IMAGE_PATH"
                               value="{{ config.ALLSKY_IMAGE_PATH }}"
                               placeholder="/home/pi/allsky/tmp/image.jpg">
                        <span class="help-text">Path to the AllSky image file on this Pi</span>
                    </div>

                    <div class="form-group">
                        <label for="allsky_url">Fallback URL (optional)</label>
                        <input type="url" id="allsky_url" name="ALLSKY_IMAGE_URL"
                               value="{{ config.ALLSKY_IMAGE_URL }}"
                               placeholder="http://192.168.1.200/current/tmp/image.jpg">
                        <span class="help-text">URL to fetch image if local file is unavailable</span>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="testStep5()">
                        Test Image Source
                    </button>
                    <div id="step5-result" class="test-result"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 6: BOM Imagery -->
    <div class="wizard-step" data-step="6">
        <div class="card">
            <div class="card-header">
                <h2>BOM Satellite & Radar</h2>
                <label class="toggle-switch">
                    <input type="checkbox" id="bom_enabled"
                           {% if config.BOM_SATELLITE_ENABLED == 'true' %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="card-body">
                <p class="step-description">
                    Enable fetching of Bureau of Meteorology satellite and radar imagery for your dashboard.
                </p>

                <div class="conditional-fields" id="bom-fields">
                    <div class="form-group">
                        <label for="bom_radar_station">Radar Station</label>
                        <select id="bom_radar_station" name="BOM_RADAR_STATION">
                            <option value="">-- Select your nearest station --</option>
                            {% for code, name in radar_stations.items() %}
                            <option value="{{ code }}" {% if config.BOM_RADAR_STATION == code %}selected{% endif %}>
                                {{ name }} ({{ code }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="bom_interval">Fetch Interval (seconds)</label>
                        <input type="range" id="bom_interval" name="BOM_SATELLITE_INTERVAL"
                               min="300" max="1800" step="60"
                               value="{{ config.BOM_SATELLITE_INTERVAL }}"
                               oninput="document.getElementById('bom_interval_val').textContent = this.value">
                        <span class="range-value" id="bom_interval_val">{{ config.BOM_SATELLITE_INTERVAL }}</span>
                        <span class="help-text">Recommended: 600 seconds (10 minutes)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 7: Review -->
    <div class="wizard-step" data-step="7">
        <div class="card">
            <div class="card-header">
                <h2>Review & Apply</h2>
            </div>
            <div class="card-body">
                <p class="step-description">
                    Review your configuration and apply the changes. The collector service will be restarted.
                </p>

                <div class="review-summary" id="review-summary">
                    <!-- Populated by JavaScript -->
                </div>

                <div class="form-group">
                    <label for="push_interval">Data Push Interval (seconds)</label>
                    <input type="range" id="push_interval" name="PUSH_INTERVAL"
                           min="10" max="300" step="10"
                           value="{{ config.PUSH_INTERVAL }}"
                           oninput="document.getElementById('push_interval_val').textContent = this.value">
                    <span class="range-value" id="push_interval_val">{{ config.PUSH_INTERVAL }}</span>
                    <span class="help-text">How often to push data to your dashboard</span>
                </div>

                <div class="form-group">
                    <label for="log_level">Log Level</label>
                    <select id="log_level" name="LOG_LEVEL">
                        <option value="DEBUG" {% if config.LOG_LEVEL == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                        <option value="INFO" {% if config.LOG_LEVEL == 'INFO' %}selected{% endif %}>INFO</option>
                        <option value="WARNING" {% if config.LOG_LEVEL == 'WARNING' %}selected{% endif %}>WARNING</option>
                        <option value="ERROR" {% if config.LOG_LEVEL == 'ERROR' %}selected{% endif %}>ERROR</option>
                    </select>
                </div>

                <div class="form-actions">
                    <label class="checkbox-label">
                        <input type="checkbox" id="restart_service" checked>
                        Restart collector service after saving
                    </label>
                </div>
            </div>
        </div>
    </div>

</form>

<!-- Navigation Buttons -->
<div class="wizard-nav">
    <button type="button" class="btn btn-secondary" id="btn-prev" onclick="prevStep()" disabled>
        Previous
    </button>
    <button type="button" class="btn btn-primary" id="btn-next" onclick="nextStep()">
        Next
    </button>
    <button type="button" class="btn btn-success" id="btn-save" onclick="saveConfig()" style="display: none;">
        Save & Apply
    </button>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentStep = 1;
const totalSteps = 7;

function updateProgress() {
    // Update progress bar
    const fill = document.getElementById('progress-fill');
    fill.style.width = `${(currentStep / totalSteps) * 100}%`;

    // Update step indicators
    document.querySelectorAll('.progress-steps .step').forEach(step => {
        const stepNum = parseInt(step.dataset.step);
        step.classList.toggle('active', stepNum === currentStep);
        step.classList.toggle('completed', stepNum < currentStep);
    });

    // Update step visibility
    document.querySelectorAll('.wizard-step').forEach(step => {
        step.classList.toggle('active', parseInt(step.dataset.step) === currentStep);
    });

    // Update buttons
    document.getElementById('btn-prev').disabled = currentStep === 1;
    document.getElementById('btn-next').style.display = currentStep === totalSteps ? 'none' : 'inline-block';
    document.getElementById('btn-save').style.display = currentStep === totalSteps ? 'inline-block' : 'none';

    // Update review summary on last step
    if (currentStep === totalSteps) {
        updateReviewSummary();
    }
}

function nextStep() {
    if (currentStep < totalSteps) {
        currentStep++;
        updateProgress();
    }
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateProgress();
    }
}

function goToStep(step) {
    currentStep = step;
    updateProgress();
}

function toggleDeviceSlot(type, slot) {
    const checkbox = document.getElementById(`${type}_${slot}_enabled`);
    const fields = document.getElementById(`${type}-${slot}-fields`);
    fields.style.display = checkbox.checked ? 'block' : 'none';
    if (!checkbox.checked) {
        // Clear host when disabled
        const hostInput = document.getElementById(`${type}_${slot}_host`);
        if (hostInput) hostInput.value = '';
    }
}

function updateReviewSummary() {
    const form = document.getElementById('wizard-form');
    let html = '<table class="review-table">';

    // API
    html += `<tr><th colspan="2">API Connection</th></tr>`;
    html += `<tr><td>URL</td><td>${form.REMOTE_API_URL.value}</td></tr>`;
    html += `<tr><td>API Key</td><td>****${form.API_KEY.value.slice(-4)}</td></tr>`;

    // Davis devices
    let davisCount = 0;
    for (let i = 1; i <= 3; i++) {
        if (document.getElementById(`davis_${i}_enabled`).checked && form[`DAVIS_${i}_HOST`].value) {
            if (davisCount === 0) html += `<tr><th colspan="2">Weather Stations</th></tr>`;
            davisCount++;
            html += `<tr><td>Davis ${i}</td><td>${form[`DAVIS_${i}_HOST`].value} (${form[`DAVIS_${i}_INTERVAL`].value}s)</td></tr>`;
        }
    }

    // SQM devices
    let sqmCount = 0;
    for (let i = 1; i <= 3; i++) {
        if (document.getElementById(`sqm_${i}_enabled`).checked && form[`SQM_${i}_HOST`].value) {
            if (sqmCount === 0) html += `<tr><th colspan="2">Sky Quality Meters</th></tr>`;
            sqmCount++;
            html += `<tr><td>SQM ${i}</td><td>${form[`SQM_${i}_HOST`].value}:${form[`SQM_${i}_PORT`].value}</td></tr>`;
        }
    }

    // Cloudwatcher devices
    let cwCount = 0;
    for (let i = 1; i <= 3; i++) {
        if (document.getElementById(`cloudwatcher_${i}_enabled`).checked && form[`CLOUDWATCHER_${i}_HOST`].value) {
            if (cwCount === 0) html += `<tr><th colspan="2">Cloud Sensors</th></tr>`;
            cwCount++;
            html += `<tr><td>Cloudwatcher ${i}</td><td>${form[`CLOUDWATCHER_${i}_HOST`].value} (${form[`CLOUDWATCHER_${i}_INTERVAL`].value}s)</td></tr>`;
        }
    }

    // AllSky
    if (document.getElementById('allsky_enabled').checked) {
        html += `<tr><th colspan="2">AllSky Camera</th></tr>`;
        if (form.ALLSKY_IMAGE_PATH.value) {
            html += `<tr><td>Path</td><td>${form.ALLSKY_IMAGE_PATH.value}</td></tr>`;
        }
        if (form.ALLSKY_IMAGE_URL.value) {
            html += `<tr><td>URL</td><td>${form.ALLSKY_IMAGE_URL.value}</td></tr>`;
        }
    }

    // BOM
    if (document.getElementById('bom_enabled').checked) {
        html += `<tr><th colspan="2">BOM Imagery</th></tr>`;
        html += `<tr><td>Radar Station</td><td>${form.BOM_RADAR_STATION.value || 'Not set'}</td></tr>`;
        html += `<tr><td>Interval</td><td>${form.BOM_SATELLITE_INTERVAL.value}s</td></tr>`;
    }

    // Summary counts
    html += `<tr><th colspan="2">Summary</th></tr>`;
    html += `<tr><td>Total Instruments</td><td>${davisCount + sqmCount + cwCount} devices configured</td></tr>`;

    html += '</table>';
    document.getElementById('review-summary').innerHTML = html;
}

// Toggle conditional fields based on checkbox state
function setupToggles() {
    const toggles = [
        ['allsky_enabled', 'allsky-fields'],
        ['bom_enabled', 'bom-fields']
    ];

    toggles.forEach(([checkboxId, fieldsId]) => {
        const checkbox = document.getElementById(checkboxId);
        const fields = document.getElementById(fieldsId);

        function updateVisibility() {
            fields.style.display = checkbox.checked ? 'block' : 'none';
        }

        checkbox.addEventListener('change', updateVisibility);
        updateVisibility();
    });
}

// Test functions
function testStep1() {
    const resultDiv = document.getElementById('step1-result');
    resultDiv.innerHTML = '<span class="loading">Testing connection...</span>';

    fetch('/api/test/api', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            url: document.getElementById('api_url').value,
            api_key: document.getElementById('api_key').value
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = '<span class="success">Connection successful!</span>';
        } else {
            resultDiv.innerHTML = `<span class="error">${data.message}</span>`;
        }
    })
    .catch(err => {
        resultDiv.innerHTML = `<span class="error">${err}</span>`;
    });
}

function testDavis(slot) {
    const resultDiv = document.getElementById(`davis-${slot}-result`);
    resultDiv.innerHTML = '<span class="loading">Testing connection...</span>';

    fetch('/api/test/weatherlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            host: document.getElementById(`davis_${slot}_host`).value
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            let html = '<span class="success">Connected!</span>';
            if (data.data) {
                html += '<div class="reading-preview">';
                if (data.data.temperature_c !== undefined) html += `<span>Temp: ${data.data.temperature_c}°C</span>`;
                if (data.data.humidity !== undefined) html += `<span>Humidity: ${data.data.humidity}%</span>`;
                if (data.data.lsid !== undefined) html += `<span>LSID: ${data.data.lsid}</span>`;
                html += '</div>';
            }
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = `<span class="error">${data.message}</span>`;
        }
    })
    .catch(err => {
        resultDiv.innerHTML = `<span class="error">${err}</span>`;
    });
}

function testSqm(slot) {
    const resultDiv = document.getElementById(`sqm-${slot}-result`);
    resultDiv.innerHTML = '<span class="loading">Testing connection...</span>';

    fetch('/api/test/sqm', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            host: document.getElementById(`sqm_${slot}_host`).value,
            port: parseInt(document.getElementById(`sqm_${slot}_port`).value)
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            let html = '<span class="success">Connected!</span>';
            if (data.data) {
                html += '<div class="reading-preview">';
                if (data.data.sky_quality !== undefined) html += `<span>SQM: ${data.data.sky_quality} mag/arcsec²</span>`;
                if (data.data.temperature !== undefined) html += `<span>Temp: ${data.data.temperature}°C</span>`;
                if (data.data.serial !== undefined) html += `<span>Serial: ${data.data.serial}</span>`;
                html += '</div>';
            }
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = `<span class="error">${data.message}</span>`;
        }
    })
    .catch(err => {
        resultDiv.innerHTML = `<span class="error">${err}</span>`;
    });
}

function testCloudwatcher(slot) {
    const resultDiv = document.getElementById(`cloudwatcher-${slot}-result`);
    resultDiv.innerHTML = '<span class="loading">Testing connection...</span>';

    fetch('/api/test/cloudwatcher', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            host: document.getElementById(`cloudwatcher_${slot}_host`).value
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            let html = '<span class="success">Connected!</span>';
            if (data.data) {
                html += '<div class="reading-preview">';
                html += `<span>Cloud: ${data.data.cloud_safe ? 'Clear' : 'Cloudy'}</span>`;
                html += `<span>Rain: ${data.data.rain_safe ? 'Dry' : 'Wet'}</span>`;
                if (data.data.serial !== undefined) html += `<span>Serial: ${data.data.serial}</span>`;
                html += '</div>';
            }
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = `<span class="error">${data.message}</span>`;
        }
    })
    .catch(err => {
        resultDiv.innerHTML = `<span class="error">${err}</span>`;
    });
}

function testStep5() {
    const resultDiv = document.getElementById('step5-result');
    resultDiv.innerHTML = '<span class="loading">Testing image source...</span>';

    fetch('/api/test/allsky', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            path: document.getElementById('allsky_path').value,
            url: document.getElementById('allsky_url').value
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `<span class="success">${data.message}</span>`;
        } else {
            resultDiv.innerHTML = `<span class="error">${data.message}</span>`;
        }
    })
    .catch(err => {
        resultDiv.innerHTML = `<span class="error">${err}</span>`;
    });
}

function saveConfig() {
    const form = document.getElementById('wizard-form');
    const config = {};

    // Collect all form values
    config.REMOTE_API_URL = form.REMOTE_API_URL.value;
    config.API_KEY = form.API_KEY.value;

    // Davis devices
    for (let i = 1; i <= 3; i++) {
        if (document.getElementById(`davis_${i}_enabled`).checked) {
            config[`DAVIS_${i}_HOST`] = form[`DAVIS_${i}_HOST`].value;
            config[`DAVIS_${i}_INTERVAL`] = form[`DAVIS_${i}_INTERVAL`].value;
        } else {
            config[`DAVIS_${i}_HOST`] = '';
            config[`DAVIS_${i}_INTERVAL`] = '30';
        }
    }

    // SQM devices
    for (let i = 1; i <= 3; i++) {
        if (document.getElementById(`sqm_${i}_enabled`).checked) {
            config[`SQM_${i}_HOST`] = form[`SQM_${i}_HOST`].value;
            config[`SQM_${i}_PORT`] = form[`SQM_${i}_PORT`].value;
        } else {
            config[`SQM_${i}_HOST`] = '';
            config[`SQM_${i}_PORT`] = '10001';
        }
    }

    // Cloudwatcher devices
    for (let i = 1; i <= 3; i++) {
        if (document.getElementById(`cloudwatcher_${i}_enabled`).checked) {
            config[`CLOUDWATCHER_${i}_HOST`] = form[`CLOUDWATCHER_${i}_HOST`].value;
            config[`CLOUDWATCHER_${i}_INTERVAL`] = form[`CLOUDWATCHER_${i}_INTERVAL`].value;
        } else {
            config[`CLOUDWATCHER_${i}_HOST`] = '';
            config[`CLOUDWATCHER_${i}_INTERVAL`] = '30';
        }
    }

    // AllSky
    if (document.getElementById('allsky_enabled').checked) {
        config.ALLSKY_IMAGE_PATH = form.ALLSKY_IMAGE_PATH.value;
        config.ALLSKY_IMAGE_URL = form.ALLSKY_IMAGE_URL.value;
    } else {
        config.ALLSKY_IMAGE_PATH = '';
        config.ALLSKY_IMAGE_URL = '';
    }

    // BOM
    config.BOM_SATELLITE_ENABLED = document.getElementById('bom_enabled').checked ? 'true' : 'false';
    if (document.getElementById('bom_enabled').checked) {
        config.BOM_RADAR_STATION = form.BOM_RADAR_STATION.value;
        config.BOM_SATELLITE_INTERVAL = form.BOM_SATELLITE_INTERVAL.value;
    }

    // Other settings
    config.PUSH_INTERVAL = form.PUSH_INTERVAL.value;
    config.LOG_LEVEL = form.LOG_LEVEL.value;

    // Save config
    fetch('/api/config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Restart service if checked
            if (document.getElementById('restart_service').checked) {
                fetch('/api/service/restart', {method: 'POST'})
                .then(r => r.json())
                .then(restartData => {
                    alert('Configuration saved and service restarted!');
                    window.location.href = '/status';
                })
                .catch(err => {
                    alert('Configuration saved but failed to restart service: ' + err);
                });
            } else {
                alert('Configuration saved!');
                window.location.href = '/status';
            }
        } else {
            alert('Failed to save configuration: ' + data.message);
        }
    })
    .catch(err => {
        alert('Error: ' + err);
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setupToggles();
    updateProgress();
});
</script>
{% endblock %}
