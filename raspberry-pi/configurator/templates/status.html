{% extends "base.html" %}

{% block title %}Status - Observatory Configurator{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Status Dashboard</h1>
    <p class="subtitle">Monitor your observatory data collector</p>
</div>

<!-- Service Status Card -->
<div class="card">
    <div class="card-header">
        <h2>Collector Service</h2>
        <div class="service-badge" id="service-badge">
            <span class="status-dot {% if service.running %}status-green{% else %}status-red{% endif %}"></span>
            <span id="service-status-text">{% if service.running %}Running{% else %}Stopped{% endif %}</span>
        </div>
    </div>
    <div class="card-body">
        <div class="service-controls">
            <button class="btn btn-success" onclick="controlService('start')" {% if service.running %}disabled{% endif %}>
                Start
            </button>
            <button class="btn btn-warning" onclick="controlService('restart')">
                Restart
            </button>
            <button class="btn btn-danger" onclick="controlService('stop')" {% if not service.running %}disabled{% endif %}>
                Stop
            </button>
        </div>
        {% if service.uptime %}
        <p class="service-uptime">Started: {{ service.uptime }}</p>
        {% endif %}
        {% if service.error %}
        <p class="error-text">{{ service.error }}</p>
        {% endif %}
    </div>
</div>

<!-- API Connection Card -->
<div class="card">
    <div class="card-header">
        <h2>API Connection</h2>
        <span class="status-indicator" id="api-status">
            <span class="status-dot status-gray"></span>
            Not tested
        </span>
    </div>
    <div class="card-body">
        <div class="info-row">
            <span class="label">URL:</span>
            <span class="value">{{ config.REMOTE_API_URL }}</span>
        </div>
        <div class="info-row">
            <span class="label">API Key:</span>
            <span class="value">{{ masked_key }}</span>
        </div>
        <button class="btn btn-primary" onclick="testApiConnection()">Test Connection</button>
        <div id="api-result" class="test-result"></div>
    </div>
</div>

<!-- SQM Devices -->
<h2 class="section-title">Sky Quality Meters</h2>
<div class="instruments-grid">
    {% for i in range(1, 4) %}
    {% set sqm_host = config['SQM_' ~ i ~ '_HOST'] %}
    <div class="instrument-card {% if sqm_host %}enabled{% else %}disabled{% endif %}">
        <div class="instrument-header">
            <h3>SQM {{ i }}</h3>
            <span class="status-indicator" id="sqm-{{ i }}-status">
                <span class="status-dot {% if sqm_host %}status-gray{% else %}status-off{% endif %}"></span>
                {% if sqm_host %}Not tested{% else %}Disabled{% endif %}
            </span>
        </div>
        <div class="instrument-body">
            {% if sqm_host %}
            <div class="info-row">
                <span class="label">Host:</span>
                <span class="value">{{ sqm_host }}:{{ config['SQM_' ~ i ~ '_PORT'] }}</span>
            </div>
            <button class="btn btn-sm" onclick="testSqm({{ i }})">Test</button>
            <div id="sqm-{{ i }}-result" class="test-result"></div>
            {% else %}
            <p class="disabled-text">Not configured</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Davis WeatherLink Devices -->
<h2 class="section-title">Davis WeatherLink Live</h2>
<div class="instruments-grid">
    {% for i in range(1, 4) %}
    {% set davis_host = config['DAVIS_' ~ i ~ '_HOST'] %}
    <div class="instrument-card {% if davis_host %}enabled{% else %}disabled{% endif %}">
        <div class="instrument-header">
            <h3>Davis {{ i }}</h3>
            <span class="status-indicator" id="davis-{{ i }}-status">
                <span class="status-dot {% if davis_host %}status-gray{% else %}status-off{% endif %}"></span>
                {% if davis_host %}Not tested{% else %}Disabled{% endif %}
            </span>
        </div>
        <div class="instrument-body">
            {% if davis_host %}
            <div class="info-row">
                <span class="label">Host:</span>
                <span class="value">{{ davis_host }}</span>
            </div>
            <div class="info-row">
                <span class="label">Interval:</span>
                <span class="value">{{ config['DAVIS_' ~ i ~ '_INTERVAL'] }}s</span>
            </div>
            <button class="btn btn-sm" onclick="testDavis({{ i }})">Test</button>
            <div id="davis-{{ i }}-result" class="test-result"></div>
            {% else %}
            <p class="disabled-text">Not configured</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Cloudwatcher Devices -->
<h2 class="section-title">AAG Cloudwatcher</h2>
<div class="instruments-grid">
    {% for i in range(1, 4) %}
    {% set cw_host = config['CLOUDWATCHER_' ~ i ~ '_HOST'] %}
    <div class="instrument-card {% if cw_host %}enabled{% else %}disabled{% endif %}">
        <div class="instrument-header">
            <h3>Cloudwatcher {{ i }}</h3>
            <span class="status-indicator" id="cloudwatcher-{{ i }}-status">
                <span class="status-dot {% if cw_host %}status-gray{% else %}status-off{% endif %}"></span>
                {% if cw_host %}Not tested{% else %}Disabled{% endif %}
            </span>
        </div>
        <div class="instrument-body">
            {% if cw_host %}
            <div class="info-row">
                <span class="label">Host:</span>
                <span class="value">{{ cw_host }}</span>
            </div>
            <div class="info-row">
                <span class="label">Interval:</span>
                <span class="value">{{ config['CLOUDWATCHER_' ~ i ~ '_INTERVAL'] }}s</span>
            </div>
            <button class="btn btn-sm" onclick="testCloudwatcher({{ i }})">Test</button>
            <div id="cloudwatcher-{{ i }}-result" class="test-result"></div>
            {% else %}
            <p class="disabled-text">Not configured</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- AllSky -->
<h2 class="section-title">Other Sources</h2>
<div class="instruments-grid">
    <div class="instrument-card {% if config.ALLSKY_IMAGE_PATH or config.ALLSKY_IMAGE_URL %}enabled{% else %}disabled{% endif %}">
        <div class="instrument-header">
            <h3>AllSky Camera</h3>
            <span class="status-indicator" id="allsky-status">
                <span class="status-dot {% if config.ALLSKY_IMAGE_PATH or config.ALLSKY_IMAGE_URL %}status-gray{% else %}status-off{% endif %}"></span>
                {% if config.ALLSKY_IMAGE_PATH or config.ALLSKY_IMAGE_URL %}Not tested{% else %}Disabled{% endif %}
            </span>
        </div>
        <div class="instrument-body">
            {% if config.ALLSKY_IMAGE_PATH %}
            <div class="info-row">
                <span class="label">Path:</span>
                <span class="value truncate">{{ config.ALLSKY_IMAGE_PATH }}</span>
            </div>
            {% endif %}
            {% if config.ALLSKY_IMAGE_URL %}
            <div class="info-row">
                <span class="label">URL:</span>
                <span class="value truncate">{{ config.ALLSKY_IMAGE_URL }}</span>
            </div>
            {% endif %}
            {% if config.ALLSKY_IMAGE_PATH or config.ALLSKY_IMAGE_URL %}
            <button class="btn btn-sm" onclick="testAllsky()">Test</button>
            <div id="allsky-result" class="test-result"></div>
            {% else %}
            <p class="disabled-text">Not configured</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- BOM Imagery -->
<div class="card">
    <div class="card-header">
        <h2>BOM Satellite & Radar</h2>
        <span class="status-indicator">
            <span class="status-dot {% if config.BOM_SATELLITE_ENABLED == 'true' %}status-green{% else %}status-off{% endif %}"></span>
            {% if config.BOM_SATELLITE_ENABLED == 'true' %}Enabled{% else %}Disabled{% endif %}
        </span>
    </div>
    <div class="card-body">
        {% if config.BOM_SATELLITE_ENABLED == 'true' %}
        <div class="info-row">
            <span class="label">Radar Station:</span>
            <span class="value">{{ config.BOM_RADAR_STATION or 'Not set' }}</span>
        </div>
        <div class="info-row">
            <span class="label">Interval:</span>
            <span class="value">{{ config.BOM_SATELLITE_INTERVAL }}s</span>
        </div>
        {% else %}
        <p class="disabled-text">BOM imagery fetching is disabled</p>
        {% endif %}
    </div>
</div>

<!-- Push Settings -->
<div class="card">
    <div class="card-header">
        <h2>Data Push Settings</h2>
    </div>
    <div class="card-body">
        <div class="info-row">
            <span class="label">Push Interval:</span>
            <span class="value">{{ config.PUSH_INTERVAL }} seconds</span>
        </div>
        <div class="info-row">
            <span class="label">Log Level:</span>
            <span class="value">{{ config.LOG_LEVEL }}</span>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Store config for tests
const deviceConfig = {
    apiUrl: "{{ config.REMOTE_API_URL }}",
    {% for i in range(1, 4) %}
    sqm{{ i }}Host: "{{ config['SQM_' ~ i ~ '_HOST'] }}",
    sqm{{ i }}Port: "{{ config['SQM_' ~ i ~ '_PORT'] }}",
    davis{{ i }}Host: "{{ config['DAVIS_' ~ i ~ '_HOST'] }}",
    cloudwatcher{{ i }}Host: "{{ config['CLOUDWATCHER_' ~ i ~ '_HOST'] }}",
    {% endfor %}
    allskyPath: "{{ config.ALLSKY_IMAGE_PATH }}",
    allskyUrl: "{{ config.ALLSKY_IMAGE_URL }}"
};

function testApiConnection() {
    const resultDiv = document.getElementById('api-result');
    const statusDiv = document.getElementById('api-status');
    resultDiv.innerHTML = '<span class="loading">Testing...</span>';

    fetch('/api/test/api', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            url: deviceConfig.apiUrl,
            api_key: '****'  // Use stored key
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<span class="status-dot status-green"></span> Connected';
            resultDiv.innerHTML = '<span class="success">Connected successfully</span>';
            if (data.data && data.data.current) {
                const c = data.data.current;
                resultDiv.innerHTML += `<div class="reading-preview">
                    <span>Temp: ${c.temperature}°C</span>
                    <span>Humidity: ${c.humidity}%</span>
                    <span>SQM: ${c.sky_quality || 'N/A'}</span>
                </div>`;
            }
        } else {
            statusDiv.innerHTML = '<span class="status-dot status-red"></span> Error';
            resultDiv.innerHTML = `<span class="error">${data.message}</span>`;
        }
    })
    .catch(err => {
        statusDiv.innerHTML = '<span class="status-dot status-red"></span> Error';
        resultDiv.innerHTML = `<span class="error">${err}</span>`;
    });
}

function testSqm(slot) {
    const resultDiv = document.getElementById(`sqm-${slot}-result`);
    const statusDiv = document.getElementById(`sqm-${slot}-status`);
    resultDiv.innerHTML = '<span class="loading">Testing...</span>';

    const host = deviceConfig[`sqm${slot}Host`];
    const port = parseInt(deviceConfig[`sqm${slot}Port`]) || 10001;

    fetch('/api/test/sqm', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({host, port})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<span class="status-dot status-green"></span> Connected';
            resultDiv.innerHTML = `<span class="success">${data.message}</span>`;
            if (data.data) {
                let preview = '<div class="reading-preview">';
                if (data.data.sky_quality !== undefined) preview += `<span>SQM: ${data.data.sky_quality} mag/arcsec²</span>`;
                if (data.data.temperature !== undefined) preview += `<span>Temp: ${data.data.temperature}°C</span>`;
                preview += '</div>';
                resultDiv.innerHTML += preview;
            }
        } else {
            statusDiv.innerHTML = '<span class="status-dot status-red"></span> Error';
            resultDiv.innerHTML = `<span class="error">${data.message}</span>`;
        }
    })
    .catch(err => {
        statusDiv.innerHTML = '<span class="status-dot status-red"></span> Error';
        resultDiv.innerHTML = `<span class="error">${err}</span>`;
    });
}

function testDavis(slot) {
    const resultDiv = document.getElementById(`davis-${slot}-result`);
    const statusDiv = document.getElementById(`davis-${slot}-status`);
    resultDiv.innerHTML = '<span class="loading">Testing...</span>';

    const host = deviceConfig[`davis${slot}Host`];

    fetch('/api/test/weatherlink', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({host})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<span class="status-dot status-green"></span> Connected';
            resultDiv.innerHTML = `<span class="success">${data.message}</span>`;
            if (data.data) {
                let preview = '<div class="reading-preview">';
                if (data.data.temperature_c !== undefined) preview += `<span>Temp: ${data.data.temperature_c}°C</span>`;
                if (data.data.humidity !== undefined) preview += `<span>Humidity: ${data.data.humidity}%</span>`;
                if (data.data.pressure_hpa !== undefined) preview += `<span>Pressure: ${data.data.pressure_hpa} hPa</span>`;
                preview += '</div>';
                resultDiv.innerHTML += preview;
            }
        } else {
            statusDiv.innerHTML = '<span class="status-dot status-red"></span> Error';
            resultDiv.innerHTML = `<span class="error">${data.message}</span>`;
        }
    })
    .catch(err => {
        statusDiv.innerHTML = '<span class="status-dot status-red"></span> Error';
        resultDiv.innerHTML = `<span class="error">${err}</span>`;
    });
}

function testCloudwatcher(slot) {
    const resultDiv = document.getElementById(`cloudwatcher-${slot}-result`);
    const statusDiv = document.getElementById(`cloudwatcher-${slot}-status`);
    resultDiv.innerHTML = '<span class="loading">Testing...</span>';

    const host = deviceConfig[`cloudwatcher${slot}Host`];

    fetch('/api/test/cloudwatcher', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({host})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<span class="status-dot status-green"></span> Connected';
            resultDiv.innerHTML = `<span class="success">${data.message}</span>`;
            if (data.data) {
                let preview = '<div class="reading-preview">';
                if (data.data.sky_temp !== undefined) preview += `<span>Sky: ${data.data.sky_temp}°C</span>`;
                if (data.data.ambient_temp !== undefined) preview += `<span>Ambient: ${data.data.ambient_temp}°C</span>`;
                preview += `<span>Safe: ${data.data.cloud_safe && data.data.rain_safe ? 'Yes' : 'No'}</span>`;
                preview += '</div>';
                resultDiv.innerHTML += preview;
            }
        } else {
            statusDiv.innerHTML = '<span class="status-dot status-red"></span> Error';
            resultDiv.innerHTML = `<span class="error">${data.message}</span>`;
        }
    })
    .catch(err => {
        statusDiv.innerHTML = '<span class="status-dot status-red"></span> Error';
        resultDiv.innerHTML = `<span class="error">${err}</span>`;
    });
}

function testAllsky() {
    const resultDiv = document.getElementById('allsky-result');
    const statusDiv = document.getElementById('allsky-status');
    resultDiv.innerHTML = '<span class="loading">Testing...</span>';

    fetch('/api/test/allsky', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            path: deviceConfig.allskyPath,
            url: deviceConfig.allskyUrl
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<span class="status-dot status-green"></span> Available';
            resultDiv.innerHTML = `<span class="success">${data.message}</span>`;
        } else {
            statusDiv.innerHTML = '<span class="status-dot status-red"></span> Error';
            resultDiv.innerHTML = `<span class="error">${data.message}</span>`;
        }
    })
    .catch(err => {
        statusDiv.innerHTML = '<span class="status-dot status-red"></span> Error';
        resultDiv.innerHTML = `<span class="error">${err}</span>`;
    });
}

function controlService(action) {
    if (!confirm(`Are you sure you want to ${action} the collector service?`)) {
        return;
    }

    fetch(`/api/service/${action}`, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        alert(data.message);
        if (data.success) {
            setTimeout(() => location.reload(), 1000);
        }
    })
    .catch(err => alert(`Error: ${err}`));
}
</script>
{% endblock %}
